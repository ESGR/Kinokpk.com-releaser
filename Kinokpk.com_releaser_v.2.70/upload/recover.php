<?

/*
 Project: Kinokpk.com releaser
 This file is part of Kinokpk.com releaser.
 Kinokpk.com releaser is based on TBDev,
 originally by RedBeard of TorrentBits, extensively modified by
 Gartenzwerg and Yuna Scatari.
 Kinokpk.com releaser is free software;
 you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
 (at your option) any later version.
 Kinokpk.com is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.
 You should have received a copy of the GNU General Public License
 along with Kinokpk.com releaser; if not, write to the
 Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
 MA  02111-1307  USA
 Do not remove above lines!
 */

require "include/bittorrent.php";

dbconn();
getlang('contact');

if ($CACHEARRAY['use_integration']) header("Location: ".$CACHEARRAY['forumurl']."/index.php?act=Reg&CODE=10");

if ($_SERVER["REQUEST_METHOD"] == "POST")
{
	if ($CACHEARRAY['use_captcha']) {
		require_once(ROOT_PATH.'include/recaptchalib.php');
		$resp = recaptcha_check_answer ($CACHEARRAY['re_privatekey'],
		$_SERVER["REMOTE_ADDR"],
		$_POST["recaptcha_challenge_field"],
		$_POST["recaptcha_response_field"]);

		if (!$resp->is_valid) stderr($tracker_lang['error'], $tracker_lang['test_humanity']);
	}

	$email = trim($_POST["email"]);
	if (!$email)
	stderr($tracker_lang['error'], "Вы должны ввести email адрес");
	$res = sql_query("SELECT * FROM users WHERE email=" . sqlesc($email) . " LIMIT 1") or sqlerr(__FILE__, __LINE__);
	$arr = mysql_fetch_array($res) or stderr($tracker_lang['error'], "Email адрес не найден в базе данных.\n");

	$sec = mksecret();

	sql_query("UPDATE users SET editsecret=" . sqlesc($sec) . " WHERE id=" . $arr["id"]) or sqlerr(__FILE__, __LINE__);
	if (!mysql_affected_rows())
	stderr($tracker_lang['error'], "Ошибка базы данных. Свяжитесь с администратором относительно этой ошибки.");

	$hash = md5($sec . $email . $arr["passhash"] . $sec);

	$body = <<<EOD
Вы, или кто-то другой, запросили новый пароль к аккаунту связаному с этим адресом ($email).

Если это были НЕ вы, проигнорируйте это письмо. Пожалуста не отвечайте.

Если вы подтверждаете этот запрос, перейдите по следующей ссылке:

	{$CACHEARRAY['defaultbaseurl']}/recover.php?confirm&id={$arr["id"]}&secret=$hash


После того как вы это сделаете, ваш пароль будет сброшен и новый пароль будет отправлен вам на E-Mail.

--
	{$CACHEARRAY['sitename']}
EOD;

	if (sent_mail($arr['email'], $CACHEARRAY['sitename'], $CACHEARRAY['siteemail'],  "{$CACHEARRAY['defaultbaseurl']} восстановление пароля",  wordwrap($body,70))==false) stderr($tracker_lang['error'],"Ошибка при отправке письма");

	stderr($tracker_lang['success'], "Подтверждающее письмо было отправлено.\n" .
		" Через несколько минут (обычно сразу) вам прийдет письмо с дальнейшими указаниями.");
}
elseif(isset($_GET['confirm']))
{
	//	if (!preg_match(':^/(\d{1,10})/([\w]{32})/(.+)$:', $_SERVER["PATH_INFO"], $matches))
	//	  httperr();

	//	$id = (int) $matches[1];
	//	$md5 = $matches[2];

	if (!is_valid_id($_GET["id"]))
	stderr($tracker_lang['error'], $tracker_lang['invalid_id']);

	$id = (int) $_GET["id"];
	$md5 = $_GET["secret"];

	$res = sql_query("SELECT username, email, passhash, editsecret FROM users WHERE id = $id");
	$arr = mysql_fetch_array($res) or stderr($tracker_lang['error'],"Нет пользователя с таким ID");

	$email = $arr["email"];

	$sec = hash_pad($arr["editsecret"]);
	if (preg_match('/^ *$/s', $sec))
	stderr($tracker_lang['error'],"Ошибка вычисления кода подтверждения");
	if ($md5 != md5($sec . $email . $arr["passhash"] . $sec))
	stderr($tracker_lang['error'],"Код подтверждения неверен");

	// generate new password;
	$chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";

	$newpassword = "";
	for ($i = 0; $i < 10; $i++)
	$newpassword .= $chars[mt_rand(0, strlen($chars) - 1)];

	$sec = mksecret();

	$newpasshash = md5($sec . $newpassword . $sec);
	//$username = @mysql_result(sql_query("SELECT username FROM users WHERE id=$id"),0);

	sql_query("UPDATE users SET secret=" . sqlesc($sec) . ", editsecret='', passhash=" . sqlesc($newpasshash) . " WHERE id=$id AND editsecret=" . sqlesc($arr["editsecret"]));

	//if ($username) change_ipb_password($newpassword,$username);

	if (!mysql_affected_rows())
	stderr($tracker_lang['error'], "Невозможно обновить данные пользователя. Пожалуста свяжитесь с администратором относительно этой ошибки.");

	$body = <<<EOD
По вашему запросу на восстановление пароля, вы сгенерировали вам новый пароль.

Вот ваши новые данные для этого аккаунта:

    Пользователь: {$arr["username"]}
    Пароль:       $newpassword

Вы можете войти на сайт тут: {$CACHEARRAY['defaultbaseurl']}/login.php

--
	{$CACHEARRAY['sitename']}
EOD;

	$mail_sent = sent_mail($email,$CACHEARRAY['sitename'],$CACHEARRAY['siteemail'], "{$CACHEARRAY['defaultbaseurl']} данные аккаунта", $body);
	if (!$mail_sent) stderr($tracker_lang['error'],'Mail not sent, configure smtp/sendmail or contact site admin');
	stderr($tracker_lang['success'], "Новые данные по аккаунту отправлены на E-Mail <b>$email</b>.\n" .
    "Через несколько минут (обычно сразу) вы получите ваши новые данные.");
}
else
{
	stdhead("Восстановление пароля");
	?>
<form method="post" action="recover.php">
<table border="1" cellspacing="0" cellpadding="5">
	<tr>
		<td class="colhead" colspan="2">Восстановление имени пользователя или
		пароля</td>
	</tr>
	<tr>
		<td colspan="2">Используйте форму ниже для востановления пароля<br />
		и ваши данные будут отправлены вам на почту.<br />
		<br />
		Вы долны будете подтвердить запрос.</td>
	</tr>
	<tr>
		<td class="rowhead">Зарегистрированый email</td>
		<td><input type="text" size="40" name="email"></td>
	</tr>
	<?php
	if ($CACHEARRAY['use_captcha']) {
		require_once(ROOT_PATH.'include/recaptchalib.php');
		print '<tr><td colspan="2" align="center">'.$tracker_lang['you_people'].'</td></tr>';
		print '<tr><td colspan="2" align="center">'.recaptcha_get_html($CACHEARRAY['re_publickey']).'</td></tr>';
	}
	?>
	<tr>
		<td colspan="2" align="center"><input type="submit"
			value="Восстановить"></td>
	</tr>
</table>
	<?
	stdfoot();
}

?>